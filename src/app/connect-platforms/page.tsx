'use client';

import { useSearchParams, useRouter } from 'next/navigation';
import { useEffect, useState, Suspense } from 'react';
import { ExternalLink } from 'lucide-react';

function ConnectPlatformsContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const [storeName, setStoreName] = useState('');
  const [storeUrl, setStoreUrl] = useState('');

  useEffect(() => {
    const name = searchParams.get('storeName');
    const url = searchParams.get('storeUrl');
    
    if (!name || !url) {
      router.push('/');
      return;
    }
    
    setStoreName(name);
    setStoreUrl(url);
  }, [searchParams, router]);

  const handleSnapchatConnect = () => {
    // الانتقال إلى OAuth Snapchat
    const state = Buffer.from(JSON.stringify({ storeName, storeUrl })).toString('base64');
    window.location.href = `/api/auth/snapchat?storeName=${encodeURIComponent(storeName)}&storeUrl=${encodeURIComponent(storeUrl)}`;
  };

  const platforms = [
    {
      id: 'snapchat',
      name: 'سناب شات',
      logo: (
        <svg viewBox="0 0 512 512" className="w-14 h-14" fill="currentColor">
          <path d="M496.926,366.6c-3.373-9.176-9.8-14.086-17.112-18.153-1.376-.806-2.641-1.451-3.72-1.947-2.182-1.128-4.414-2.22-6.634-3.3-22.8-11.1-40.642-19.8-46.671-66.3-.395-3.027-.714-6.082-1.027-9.095-1.321-12.883-2.571-25.055-7.6-33.984a33.4,33.4,0,0,0-7.78-9.234,32.47,32.47,0,0,0-18.2-8.3,19.4,19.4,0,0,0-3.2-.248c-13.056,0-24.253,10.4-32.1,29.938-6.1,15.2-11.7,38.7-16.7,69.8-1.9,11.8-3.7,24.3-5.5,37.6-1.8,13.3-3.6,27.1-5.5,41.4-1.9,14.3-3.8,29.1-5.7,44.5-1.9,15.4-3.8,31.3-5.7,47.8-1.9,16.5-3.8,33.6-5.7,51.3-1.9,17.7-3.8,36-5.7,54.9-1.9,18.9-3.8,38.4-5.7,58.5-1.9,20.1-3.8,40.8-5.7,62.1-1.9,21.3-3.8,43.2-5.7,65.7-1.9,22.5-3.8,45.6-5.7,69.3-1.9,23.7-3.8,48-5.7,72.9-1.9,24.9-3.8,50.4-5.7,76.5-1.9,26.1-3.8,52.8-5.7,80.1-1.9,27.3-3.8,55.2-5.7,83.7-1.9,28.5-3.8,57.6-5.7,87.3-1.9,29.7-3.8,60-5.7,90.9-1.9,30.9-3.8,62.4-5.7,94.5-1.9,32.1-3.8,64.8-5.7,98.1-1.9,33.3-3.8,67.2-5.7,101.7-1.9,34.5-3.8,69.6-5.7,105.3-1.9,35.7-3.8,72-5.7,108.9-1.9,36.9-3.8,74.4-5.7,112.5-1.9,38.1-3.8,76.8-5.7,116.1-1.9,39.3-3.8,79.2-5.7,119.7-1.9,40.5-3.8,81.6-5.7,123.3-1.9,41.7-3.8,84-5.7,126.9-1.9,42.9-3.8,86.4-5.7,130.5-1.9,44.1-3.8,88.8-5.7,134.1-1.9,45.3-3.8,91.2-5.7,137.7-1.9,46.5-3.8,93.6-5.7,141.3-1.9,47.7-3.8,96-5.7,144.9-1.9,48.9-3.8,98.4-5.7,148.5-1.9,50.1-3.8,100.8-5.7,152.1-1.9,51.3-3.8,103.2-5.7,155.7-1.9,52.5-3.8,105.6-5.7,159.3-1.9,53.7-3.8,108-5.7,162.9-1.9,54.9-3.8,110.4-5.7,166.5-1.9,56.1-3.8,112.8-5.7,170.1-1.9,57.3-3.8,115.2-5.7,173.7-1.9,58.5-3.8,117.6-5.7,177.3-1.9,59.7-3.8,120-5.7,180.9-1.9,60.9-3.8,122.4-5.7,184.5-1.9,62.1-3.8,124.8-5.7,188.1-1.9,63.3-3.8,127.2-5.7,191.7-1.9,64.5-3.8,129.6-5.7,195.3-1.9,65.7-3.8,132-5.7,198.9-1.9,66.9-3.8,134.4-5.7,202.5-1.9,68.1-3.8,136.8-5.7,206.1-1.9,69.3-3.8,139.2-5.7,209.7-1.9,70.5-3.8,141.6-5.7,213.3-1.9,71.7-3.8,144-5.7,216.9-1.9,72.9-3.8,146.4-5.7,220.5-1.9,74.1-3.8,148.8-5.7,224.1-1.9,75.3-3.8,151.2-5.7,227.7-1.9,76.5-3.8,153.6-5.7,231.3-1.9,77.7-3.8,156-5.7,234.9-1.9,78.9-3.8,158.4-5.7,238.5-1.9,80.1-3.8,160.8-5.7,242.1-1.9,81.3-3.8,163.2-5.7,245.7-1.9,82.5-3.8,165.6-5.7,249.3-1.9,83.7-3.8,168-5.7,252.9-1.9,84.9-3.8,170.4-5.7,256.5-1.9,86.1-3.8,172.8-5.7,260.1-1.9,87.3-3.8,175.2-5.7,263.7-1.9,88.5-3.8,177.6-5.7,267.3-1.9,89.7-3.8,180-5.7,270.9-1.9,90.9-3.8,182.4-5.7,274.5-1.9,92.1-3.8,184.8-5.7,278.1-1.9,93.3-3.8,187.2-5.7,281.7-1.9,94.5-3.8,189.6-5.7,285.3-1.9,95.7-3.8,192-5.7,288.9-1.9,96.9-3.8,194.4-5.7,292.5-1.9,98.1-3.8,196.8-5.7,296.1-1.9,99.3-3.8,199.2-5.7,299.7-1.9,100.5-3.8,201.6-5.7,303.3-1.9,101.7-3.8,204-5.7,306.9-1.9,102.9-3.8,206.4-5.7,310.5-1.9,104.1-3.8,208.8-5.7,314.1-1.9,105.3-3.8,211.2-5.7,317.7-1.9,106.5-3.8,213.6-5.7,321.3-1.9,107.7-3.8,216-5.7,324.9-1.9,108.9-3.8,218.4-5.7,328.5-1.9,110.1-3.8,220.8-5.7,332.1-1.9,111.3-3.8,223.2-5.7,335.7-1.9,112.5-3.8,225.6-5.7,339.3-1.9,113.7-3.8,228-5.7,342.9-1.9,114.9-3.8,230.4-5.7,346.5-1.9,116.1-3.8,232.8-5.7,350.1-1.9,117.3-3.8,235.2-5.7,353.7-1.9,118.5-3.8,237.6-5.7,357.3-1.9,119.7-3.8,240-5.7,360.9-1.9,120.9-3.8,242.4-5.7,364.5-1.9,122.1-3.8,244.8-5.7,368.1-1.9,123.3-3.8,247.2-5.7,371.7-1.9,124.5-3.8,249.6-5.7,375.3-1.9,125.7-3.8,252-5.7,378.9-1.9,126.9-3.8,254.4-5.7,382.5-1.9,128.1-3.8,256.8-5.7,386.1-1.9,129.3-3.8,259.2-5.7,389.7-1.9,130.5-3.8,261.6-5.7,393.3-1.9,131.7-3.8,264-5.7,396.9-1.9,132.9-3.8,266.4-5.7,400.5-1.9,134.1-3.8,268.8-5.7,404.1-1.9,135.3-3.8,271.2-5.7,407.7-1.9,136.5-3.8,273.6-5.7,411.3-1.9,137.7-3.8,276-5.7,414.9-1.9,138.9-3.8,278.4-5.7,418.5-1.9,140.1-3.8,280.8-5.7,422.1-1.9,141.3-3.8,283.2-5.7,425.7-1.9,142.5-3.8,285.6-5.7,429.3-1.9,143.7-3.8,288-5.7,432.9-1.9,144.9-3.8,290.4-5.7,436.5-1.9,146.1-3.8,292.8-5.7,440.1-1.9,147.3-3.8,295.2-5.7,443.7-1.9,148.5-3.8,297.6-5.7,447.3-1.9,149.7-3.8,300-5.7,450.9-1.9,150.9-3.8,302.4-5.7,454.5-1.9,152.1-3.8,304.8-5.7,458.1-1.9,153.3-3.8,307.2-5.7,461.7-1.9,154.5-3.8,309.6-5.7,465.3-1.9,155.7-3.8,312-5.7,468.9-1.9,156.9-3.8,314.4-5.7,472.5-1.9,158.1-3.8,316.8-5.7,476.1-1.9,159.3-3.8,319.2-5.7,479.7-1.9,160.5-3.8,321.6-5.7,483.3-1.9,161.7-3.8,324-5.7,486.9-1.9,162.9-3.8,326.4-5.7,490.5-1.9,164.1-3.8,328.8-5.7,494.1-1.9,165.3-3.8,331.2-5.7,497.7-1.9,166.5-3.8,333.6-5.7,501.3-1.9,167.7-3.8,336-5.7,504.9-1.9,168.9-3.8,338.4-5.7,508.5-1.9,170.1-3.8,340.8-5.7,512.1"/>
        </svg>
      ),
      color: 'bg-yellow-400',
      available: true,
      onClick: handleSnapchatConnect
    },
    {
      id: 'tiktok',
      name: 'تيك توك',
      logo: (
        <svg viewBox="0 0 448 512" className="w-14 h-14" fill="currentColor">
          <path d="M448,209.91a210.06,210.06,0,0,1-122.77-39.25V349.38A162.55,162.55,0,1,1,185,188.31V278.2a74.62,74.62,0,1,0,52.23,71.18V0l88,0a121.18,121.18,0,0,0,1.86,22.17h0A122.18,122.18,0,0,0,381,102.39a121.43,121.43,0,0,0,67,20.14Z"/>
        </svg>
      ),
      color: 'bg-black',
      available: false
    },
    {
      id: 'meta',
      name: 'ميتا',
      logo: (
        <svg viewBox="0 0 512 512" className="w-14 h-14" fill="currentColor">
          <path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/>
        </svg>
      ),
      color: 'bg-blue-600',
      available: false
    },
    {
      id: 'google',
      name: 'قوقل',
      logo: (
        <svg viewBox="0 0 488 512" className="w-14 h-14">
          <path fill="#4285F4" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/>
        </svg>
      ),
      color: 'bg-white border-2 border-gray-200',
      available: false
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-xl shadow-lg p-8 max-w-4xl w-full">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ربط حساباتك الإعلانية
          </h1>
          <p className="text-gray-600">
            {storeName} - اختر المنصات التي تريد ربطها
          </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {platforms.map((platform) => (
            <div
              key={platform.id}
              className={`relative border-2 rounded-xl p-6 transition ${
                platform.available
                  ? 'border-gray-200 hover:border-primary-400 cursor-pointer hover:shadow-md'
                  : 'border-gray-100 opacity-60'
              }`}
              onClick={platform.available ? platform.onClick : undefined}
            >
              {!platform.available && (
                <div className="absolute top-3 right-3">
                  <span className="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                    غير متوفر
                  </span>
                </div>
              )}

              <div className="flex flex-col items-center text-center">
                <div className={`w-20 h-20 ${platform.color} rounded-full flex items-center justify-center mb-4 text-white text-4xl`}>
                  {platform.icon}
                </div>
                
                <h3 className="text-xl font-bold text-gray-900 mb-2">
                  {platform.name}
                </h3>

                {platform.available ? (
                  <button
                    className="mt-4 w-full bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition flex items-center justify-center gap-2"
                  >
                    <ExternalLink className="w-5 h-5" />
                    ربط الحساب
                  </button>
                ) : (
                  <div className="mt-4 w-full bg-gray-100 text-gray-500 px-6 py-3 rounded-lg font-semibold cursor-not-allowed">
                    قريباً
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>

        <div className="mt-8 text-center">
          <button
            onClick={() => router.push('/')}
            className="text-gray-600 hover:text-gray-900 underline"
          >
            العودة للصفحة الرئيسية
          </button>
        </div>
      </div>
    </div>
  );
}

export default function ConnectPlatformsPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-pulse">جاري التحميل...</div>
      </div>
    }>
      <ConnectPlatformsContent />
    </Suspense>
  );
}
